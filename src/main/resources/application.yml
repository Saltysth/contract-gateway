server:
  port: 9090
  servlet:
    context-path: /contract-gateway

spring:
  datasource:
    driver-class-name: org.postgresql.Driver
    url: ${DB_URL:jdbc:postgresql://localhost:5432/postgres}
    username: ${DB_USERNAME:postgres}
    password: ${DB_PASSWORD:SaltyFish}
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000

  jpa:
    hibernate:
      ddl-auto: update
    show-sql: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: true


  cloud:
    gateway:
      server:
        webflux:
          # 基础路由配置 - 支持通过Nacos动态覆盖
          routes:
            # 合同管理服务路由 (/cm/** -> contract-management-service)
            - id: contract-management-service-route
              uri: lb://contract-management-service
              predicates:
                - Path=/cm/**
              filters:
                # 剥离 /cm 后，追加服务的上下文路径 /contract-management
                - RewritePath=/cm/(?<path>.*), /contract-management/$\{path}
                - AddRequestHeader=X-Gateway-Source, contract-gateway
              metadata:
                service-name: contract-management-service
                description: "合同审查管理服务路由"

            # 合同审查引擎服务路由 (/cre/** -> contract-review-engine)
            - id: contract-review-engine-route
              uri: lb://contract-review-engine
              predicates:
                - Path=/cre/**
              filters:
                - RewritePath=/cre/(?<path>.*), /contract-review-engine/$\{path}
                - AddRequestHeader=X-Gateway-Source, contract-gateway
              metadata:
                service-name: contract-review-engine
                description: "合同审查引擎服务路由"

            # 文件存储服务路由 (/cfs/** -> contract-file-storage-service)
            - id: contract-file-storage-service-route
              uri: lb://contract-file-storage-service
              predicates:
                - Path=/cfs/**
              filters:
                - RewritePath=/cfs/(?<path>.*), /contract-file/$\{path}
                - AddRequestHeader=X-Gateway-Source, contract-gateway
              metadata:
                service-name: contract-file-storage-service
                description: "文件存储服务路由"

            # AI服务路由 (/cai/** -> contract-ai-service)
            - id: contract-ai-service-route
              uri: lb://contract-ai-service
              predicates:
                - Path=/cai/**
              filters:
                - RewritePath=/cai/(?<path>.*), /contract-ai/$\{path}
                - AddRequestHeader=X-Gateway-Source, contract-gateway
              metadata:
                service-name: contract-ai-service
                description: "AI服务路由"

            # 若依鉴权服务路由 (/csr/** -> contract-security-ruoyi)
            - id: contract-security-ruoyi
              uri: lb://contract-security-ruoyi
              predicates:
                - Path=/csr/**
              filters:
                - RewritePath=/csr/(?<path>.*), /contract-security-ruoyi/$\{path}
                - AddRequestHeader=X-Gateway-Source, contract-gateway
              metadata:
                service-name: contract-security-ruoyi
                description: "若依鉴权服务路由"

            # 网关本地服务路由 (/cg/** -> 本地服务)
            - id: contract-gateway-route
              uri: http://localhost:${server.port}
              predicates:
                - Path=/cg/**
              filters:
                - RewritePath=/cg/(?<path>.*), /contract-gateway/$\{path}
                - PreserveHostHeader
              metadata:
                service-name: contract-gateway
                description: "网关本地服务路由"

            # 健康检查和管理端点路由 - 不转发，直接处理
            - id: actuator-route
              uri: http://localhost:${server.port}
              predicates:
                - Path=/actuator/**
              filters:
                - PreserveHostHeader
              metadata:
                description: "本地监控端点路由"


            # 健康状态API路由 - 不转发，直接处理
            - id: health-api-route
              uri: http://localhost:${server.port}
              predicates:
                - Path=/actuator/health/**
              filters:
                - PreserveHostHeader
              metadata:
                description: "本地健康状态API路由"

            # 健康检查接口路由 - 不转发，直接处理
            - id: health-services-route
              uri: http://localhost:${server.port}
              predicates:
                - Path=/health/**
              filters:
                - PreserveHostHeader
              metadata:
                description: "本地健康检查接口路由"

            # 健康状态页面路由 - 静态资源，不转发
            - id: health-dashboard-route
              uri: http://localhost:${server.port}
              predicates:
                - Path=/health-dashboard.html,/health-dashboard
              filters:
                - PreserveHostHeader
                - RewritePath=/health-dashboard, /health-dashboard.html
              metadata:
                description: "健康状态展示页面路由"
          # 跨域配置 - 注释掉以避免与CorsWebFilter冲突
          # globalcors:
          #   cors-configurations:
          #     # 匹配所有请求路径
          #     '[/**]':
          #       # 允许的源（前端公网地址，测试阶段可设为*，生产需指定具体域名）
          #       allowed-origin-patterns: "*"
          #       # 允许的请求方法（GET/POST/PUT/DELETE等，*表示所有）
          #       allowed-methods: "*"
          #       # 允许的请求头（*表示所有，如token、content-type等）
          #       allowed-headers: "*"
          #       # 是否允许携带凭证（cookie/token等，前端需要传凭证时设为true）
          #       allow-credentials: true
          #       # 预检请求（OPTIONS）的缓存时间（秒），避免频繁预检
          #       max-age: 3600
          discovery:
            locator:
              enabled: true
              lower-case-service-id: true

  data:
    redis:
      host: ${REDIS_HOST:localhost}
      database: ${REDIS_DATABASE:0}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      timeout: 3000ms

logging:
  level:
    org.springframework.cloud.gateway: INFO
    org.springframework.cloud.loadbalancer: INFO
    com.saltyfish.contract.gateway: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"

  file:
    name: logs/contract-gateway.log

management:
  endpoints:
    web:
      exposure:
        include: health,info,prometheus,gateway
      base-path: /actuator
    cors:
      allowed-origins: "*"
      allowed-methods: GET,POST
  endpoint:
    health:
      show-details: always
      show-components: always
  health:
    defaults:
      enabled: true
    redis:
      enabled: true
    diskspace:
      enabled: true
      threshold: 100MB
  prometheus:
    metrics:
      export:
        enabled: true


# 网关配置
gateway:
  # 黑白名单配置
  access-control:
    enabled: true
    default-policy: allow # allow/deny
  # URL映射配置
  url-mapping:
    enabled: true
  # 监控配置
  monitoring:
    enabled: true